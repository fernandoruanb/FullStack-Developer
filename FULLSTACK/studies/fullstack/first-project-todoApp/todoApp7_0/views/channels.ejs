<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="author" content="Fernando Ruan">
		<script src="/socket.io/socket.io.js"></script>
		<title>Channels</title>
	</head>
	<body>
		<main>
			<header>
				<nav>
					<a href="/getDashBoard">Dashboard</a>
				</nav>
			</header>
			<section>
				<h2>Welcome to the chat <%= user %> :)</h2>
			</section>
			<section>
				<h4>Channels</h4>
				<ul id="allChannels">
				</ul>
			</section>
			<section>
				<h4>People on the chat</h4>
				<ul id="list">
				</ul>
			</section>
			<section>
				<div id="messages" style="border: 1px solid">
				</div><br>
				<div>
					<form id="chatForm">
                                        	<label>
                                                	Input: 
                                                	<input type="text" id="formMessage" name="message" placeholder="Type the message here" required>
                                                	<button type="submit">Send</button>
                                        	</label>
					</form>
					<form id="createChannel">
						<label>
							Create:
							<input type="text" id="formChannel" name="channel" placeholder="Type here the name of new Channel" required>
							<button type="submit">NewChannel</button>
						</label>
					</form>
                                </div>
			</section>
			<section>
				<script>
					const formChannel = document.getElementById("createChannel");
					const ch = document.getElementById("formChannel");
					const form = document.getElementById("chatForm");
					const msg = document.getElementById("formMessage");
					const user = "<%= user %>";
					const socket = io();

					// e.preventDefault -> avoid to restart the page 

					formChannel.addEventListener("submit", (e) => {
						e.preventDefault();
						const text = ch.value.trim();
						if (!text) return ;
						socket.emit("createChannel", text);
						ch.value = "";
					});

					form.addEventListener("submit", (e) => {
						e.preventDefault();
						const text = msg.value.trim();
						if (!text) return ; 
						socket.emit("sendMessage", user, text);
						msg.value = "";
					});

					socket.on("connect", () => {
						const user = "<%= user %>";
						socket.emit("join", user);
					});

					socket.on("updateChannels", (allChannels) => {
						const channels = document.getElementById("allChannels");
						channels.innerHTML = "";
						allChannels.forEach((channel) => {
							const li = document.createElement("li");
							const p = document.createElement("p");

							p.textContent = channel;
							p.style.cursor = "pointer";
							// 4 pixels up and bottow and 0 laterals
							p.style.margin = "4px 0";
							p.style.fontWeight = "bold";
							p.style.color = "blue";
							li.appendChild(p);

							p.addEventListener("click", () => {
								socket.emit("joinChannel", { user: "<%= user %>", roomName: channel });
							});
							channels.appendChild(li);
						});
					});

					socket.on("updateUsers", (users) => {
						const list = document.getElementById("list");
						list.innerHTML = ""; // clean the list
						users.forEach((user) => {
							const li = document.createElement("li");
							li.textContent = user;
							list.appendChild(li);
						});
					});

					socket.on("sendMessage", (messages) => {
						const messagesDiv = document.getElementById("messages");
						messagesDiv.innerHTML = "";
						messages.forEach((msg) => {
							const p = document.createElement("p");
							p.textContent = msg;
							messagesDiv.appendChild(p);
						});
					});

					socket.on("updateUsername", () => {
						socket.emit
					});

					socket.on("disconnect", () => {
						console.log("Disconnected from server");
					});
				</script>
			</section>
			<footer>
				<h6>Keysoft Softwares</h6>
			</footer>
		</main>
	</body>
</html>
